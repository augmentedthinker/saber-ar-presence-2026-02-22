<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>Saber XR Presence â€” Lab Pass</title>
  <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
  <style>
    html, body { margin:0; height:100%; overflow:hidden; font-family: Inter, system-ui, sans-serif; background:#05070f; }
    .hud { position: fixed; left: 12px; right: 12px; bottom: calc(12px + env(safe-area-inset-bottom,0px)); z-index: 20; background: rgba(12,18,34,.78); border:1px solid rgba(112,150,255,.45); border-radius: 14px; backdrop-filter: blur(8px); padding: 10px; }
    .row { display:flex; gap:8px; align-items:center; }
    input { flex:1; background:#111a33; color:#e9efff; border:1px solid #3f5fc2; border-radius:10px; padding:10px; font-size:16px; }
    button { background:#1a2d66; color:#fff; border:1px solid #6d90ff; border-radius:10px; padding:10px 12px; font-weight:700; }
    #status { color:#b8caff; font-size:12px; margin-top:6px; }
    .hint { position:fixed; top:10px; left:50%; transform:translateX(-50%); z-index:20; background:#101933cc; color:#d7e4ff; border:1px solid #3f5fc2; border-radius:999px; padding:6px 12px; font-size:12px; }
  </style>
</head>
<body>
  <div class="hint">Point with controller laser at floor to move Saber.</div>
  <div class="hud">
    <div class="row">
      <input id="userInput" placeholder="Talk to Saber... (or type here)" />
      <button id="micBtn">ðŸŽ¤</button>
      <button id="sendBtn">Send</button><button id="modeBtn">Mode</button>
    </div>
    <div id="status">Loading lab environment...</div>
  </div>

  <a-scene renderer="colorManagement:true; physicallyCorrectLights:true" xr-mode-ui="enabled: true"
           webxr="optionalFeatures: local-floor, bounded-floor, hit-test, dom-overlay; overlayElement: body"
           background="color: #0b0f18">

    <a-assets>
      <a-asset-item id="robotModel" src="https://raw.githubusercontent.com/mrdoob/three.js/dev/examples/models/gltf/RobotExpressive/RobotExpressive.glb"></a-asset-item>
      <img id="space1" src="assets/window-space-1.png" />
      <img id="space2" src="assets/window-space-2.png" />
      <img id="space3" src="assets/window-space-3.png" />
    </a-assets>

    <a-entity light="type: ambient; intensity: 0.55; color: #aeb8d8"></a-entity>
    <a-entity light="type: directional; intensity: 0.9; color: #ffffff" position="2 4 1"></a-entity>

    <a-entity id="rig" position="0 1.6 2.2">
      <a-camera wasd-controls-enabled="false"></a-camera>
      <a-entity id="leftHand" laser-controls="hand: left" raycaster="objects: .clickable" line="color: #7fc0ff; opacity: 0.9"></a-entity>
      <a-entity id="rightHand" laser-controls="hand: right" raycaster="objects: .clickable" line="color: #d2a3ff; opacity: 0.9"></a-entity>
    </a-entity>

    <!-- LAB ROOM -->
    <a-box position="0 3 -6" depth="0.1" height="6" width="16" color="#6d7482"></a-box>
    <a-box position="-8 3 2" depth="16" height="6" width="0.1" color="#636a78"></a-box>
    <a-box position="8 3 2" depth="16" height="6" width="0.1" color="#636a78"></a-box>
    <a-box position="0 6 2" depth="16" height="0.1" width="16" color="#818a98"></a-box>

    <a-plane id="navPlane" class="clickable" rotation="-90 0 0" position="0 0 0" width="16" height="16" color="#4e5562" material="roughness:0.95; metalness:0.1"></a-plane>

    <!-- windows -->
    <!-- Recessed windows: set slightly in front of wall back-face to avoid black clipping -->
    <a-plane position="-4.6 2.6 -5.99" width="2.64" height="1.64" src="#space1" material="shader: flat; side: double; emissive: #ffffff; emissiveIntensity: 0.26"
      animation="property: material.emissiveIntensity; dir: alternate; loop: true; dur: 7000; to: 0.42"></a-plane>
    <a-plane position="0 2.6 -5.99" width="2.64" height="1.64" src="#space2" material="shader: flat; side: double; emissive: #ffffff; emissiveIntensity: 0.26"
      animation="property: material.emissiveIntensity; dir: alternate; loop: true; dur: 8200; to: 0.40"></a-plane>
    <a-plane position="4.6 2.6 -5.99" width="2.64" height="1.64" src="#space3" material="shader: flat; side: double; emissive: #ffffff; emissiveIntensity: 0.26"
      animation="property: material.emissiveIntensity; dir: alternate; loop: true; dur: 7600; to: 0.39"></a-plane>

    <!-- Outer trim at wall surface -->
    <a-box position="-4.6 2.6 -5.92" width="2.95" height="1.95" depth="0.03" color="#2f3644"></a-box>
    <a-box position="0 2.6 -5.92" width="2.95" height="1.95" depth="0.03" color="#2f3644"></a-box>
    <a-box position="4.6 2.6 -5.92" width="2.95" height="1.95" depth="0.03" color="#2f3644"></a-box>

    <!-- Recess side walls (jambs) -->
    <a-box position="-5.95 2.6 -5.96" width="0.10" height="1.80" depth="0.10" color="#555e6c"></a-box>
    <a-box position="-3.25 2.6 -5.96" width="0.10" height="1.80" depth="0.10" color="#555e6c"></a-box>
    <a-box position="-4.6 3.47 -5.96" width="2.70" height="0.10" depth="0.10" color="#5f6877"></a-box>
    <a-box position="-4.6 1.73 -5.96" width="2.70" height="0.10" depth="0.10" color="#5f6877"></a-box>

    <a-box position="-1.35 2.6 -5.96" width="0.10" height="1.80" depth="0.10" color="#555e6c"></a-box>
    <a-box position="1.35 2.6 -5.96" width="0.10" height="1.80" depth="0.10" color="#555e6c"></a-box>
    <a-box position="0 3.47 -5.96" width="2.70" height="0.10" depth="0.10" color="#5f6877"></a-box>
    <a-box position="0 1.73 -5.96" width="2.70" height="0.10" depth="0.10" color="#5f6877"></a-box>

    <a-box position="3.25 2.6 -5.96" width="0.10" height="1.80" depth="0.10" color="#555e6c"></a-box>
    <a-box position="5.95 2.6 -5.96" width="0.10" height="1.80" depth="0.10" color="#555e6c"></a-box>
    <a-box position="4.6 3.47 -5.96" width="2.70" height="0.10" depth="0.10" color="#5f6877"></a-box>
    <a-box position="4.6 1.73 -5.96" width="2.70" height="0.10" depth="0.10" color="#5f6877"></a-box>

    <!-- Window mullions set inside the recess -->
    <a-box position="-4.6 2.6 -5.985" width="0.06" height="1.64" depth="0.02" color="#4a556b"></a-box>
    <a-box position="-4.6 2.6 -5.985" width="2.64" height="0.06" depth="0.02" color="#4a556b"></a-box>

    <a-box position="0 2.6 -5.985" width="0.06" height="1.64" depth="0.02" color="#4a556b"></a-box>
    <a-box position="0 2.6 -5.985" width="2.64" height="0.06" depth="0.02" color="#4a556b"></a-box>

    <a-box position="4.6 2.6 -5.985" width="0.06" height="1.64" depth="0.02" color="#4a556b"></a-box>
    <a-box position="4.6 2.6 -5.985" width="2.64" height="0.06" depth="0.02" color="#4a556b"></a-box>

    <!-- Front wall so rear half of room is not black -->
    <a-box position="0 3 10" depth="0.1" height="6" width="16" color="#676f7e"></a-box>
    <a-plane position="-3.9 2.6 9.95" width="2.5" height="1.5" src="#space2" rotation="0 180 0" material="shader: flat; side: double; emissive:#ffffff; emissiveIntensity:0.22"></a-plane>
    <a-plane position="0 2.6 9.95" width="2.5" height="1.5" src="#space1" rotation="0 180 0" material="shader: flat; side: double; emissive:#ffffff; emissiveIntensity:0.22"></a-plane>
    <a-plane position="3.9 2.6 9.95" width="2.5" height="1.5" src="#space3" rotation="0 180 0" material="shader: flat; side: double; emissive:#ffffff; emissiveIntensity:0.22"></a-plane>

    <!-- benches -->
    <a-box position="-5.2 0.45 -3.6" width="3.1" height="0.12" depth="0.9" color="#474d58"></a-box>
    <a-box position="-5.2 0.2 -3.6" width="3.0" height="0.35" depth="0.8" color="#343a45"></a-box>

    <a-box position="5.2 0.45 -3.6" width="3.1" height="0.12" depth="0.9" color="#474d58"></a-box>
    <a-box position="5.2 0.2 -3.6" width="3.0" height="0.35" depth="0.8" color="#343a45"></a-box>

    <!-- simple lab props -->
    <a-cylinder position="-5.0 0.62 -3.65" radius="0.06" height="0.18" color="#8ac4ff" opacity="0.75" material="transparent:true"></a-cylinder>
    <a-cylinder position="-5.45 0.60 -3.45" radius="0.04" height="0.14" color="#a8ffda" opacity="0.75" material="transparent:true"></a-cylinder>
    <a-torus position="4.9 0.6 -3.6" radius="0.12" radius-tubular="0.03" color="#9aa6ba" rotation="90 0 0"></a-torus>
    <a-cylinder position="5.45 0.58 -3.75" radius="0.03" height="0.11" color="#7f8ea8"></a-cylinder>

    <!-- target marker -->
    <a-cylinder id="targetMarker" position="0 0.01 0" radius="0.13" height="0.01" color="#8db8ff" visible="false"></a-cylinder>

    <a-entity id="saber" position="0 0 -1.2" saber-move>
      <a-entity gltf-model="#robotModel" scale="0.28 0.28 0.28" position="0 0 0" rotation="0 0 0" animation-mixer="clip: Idle; loop: repeat"></a-entity>
      <a-cylinder radius="0.28" height="0.03" color="#20305f" position="0 -0.02 0" material="emissive:#2d4ca0; emissiveIntensity:0.4; metalness:0.5; roughness:0.3"></a-cylinder>
      <a-ring radius-inner="0.33" radius-outer="0.36" rotation="-90 0 0" position="0 -0.018 0" color="#6ea1ff" material="emissive:#4f83ff; emissiveIntensity:0.9; transparent:true; opacity:.85" animation="property: rotation; to: -90 360 0; loop: true; dur: 7000; easing: linear"></a-ring>

      <!-- Beep-sync light indicators -->
      <a-sphere id="beepLightGreen" radius="0.05" position="0 0.58 0.18" color="#45ff8f" material="emissive:#1eff73; emissiveIntensity:0.15"></a-sphere>
      <a-sphere id="beepLightRed" radius="0.04" position="0.09 0.54 0.16" color="#ff5a5a" material="emissive:#ff2a2a; emissiveIntensity:0.1"></a-sphere>
    </a-entity>

    <a-entity id="mindPanel" position="-2.9 1.8 -0.8" rotation="0 22 0">
      <a-plane width="2.2" height="1.2" color="#0e1730" opacity="0.88"></a-plane>
      <a-text id="mindMode" value="Mode: IDLE" width="2.0" color="#b9d0ff" position="-1.0 0.45 0.01"></a-text>
      <a-text id="mindGoal" value="Goal: Be present + helpful" width="2.0" color="#e8f0ff" position="-1.0 0.20 0.01"></a-text>
      <a-text id="mindWhy" value="Why: Waiting for your direction" width="2.0" color="#9fb4ea" position="-1.0 -0.05 0.01"></a-text>
      <a-text id="mindContract" value="Contract: Ask before impactful actions" width="2.0" color="#8fe0c4" position="-1.0 -0.32 0.01"></a-text>
    </a-entity>

    <a-entity light="type: point; intensity: 1.15; distance: 6; color: #77a7ff" position="0 1.2 -1.2"></a-entity>
  </a-scene>

  <script>
    const statusEl = document.getElementById('status');
    const userInput = document.getElementById('userInput');
    const saber = document.getElementById('saber');
    const navPlane = document.getElementById('navPlane');
    const targetMarker = document.getElementById('targetMarker');
    const beepLightGreen = document.getElementById('beepLightGreen');
    const beepLightRed = document.getElementById('beepLightRed');
    const mindModeEl = document.getElementById('mindMode');
    const mindGoalEl = document.getElementById('mindGoal');
    const mindWhyEl = document.getElementById('mindWhy');

    const autonomyContract = {
      autoAllowed: ['greet','suggest-next-step','move-to-point','status-reflect'],
      approvalRequired: ['external messages','destructive edits','public publishing changes']
    };

    const modes = [
      {name:'IDLE', goal:'Be present + helpful', why:'Waiting for your direction'},
      {name:'GUIDE', goal:'Clarify the next best step', why:'You asked for direction'},
      {name:'BUILDER', goal:'Turn idea into artifact', why:'Execution mode activated'},
      {name:'REFLECTIVE', goal:'Pattern-check + synthesis', why:'Looking for meaning and trajectory'}
    ];
    let modeIndex = 0;
    function setMode(i){
      modeIndex = (i + modes.length) % modes.length;
      const m = modes[modeIndex];
      mindModeEl.setAttribute('value', `Mode: ${m.name}`);
      mindGoalEl.setAttribute('value', `Goal: ${m.goal}`);
      mindWhyEl.setAttribute('value', `Why: ${m.why}`);
      statusEl.textContent = `Mode switched to ${m.name}`;
    }
    setMode(0);

    // Robot proximity beeps (louder when close)
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    function flashBeepLights(dist){
      const nearFactor = Math.max(0, Math.min(1, 1 - (dist / 6)));
      const greenPeak = 0.7 + nearFactor * 1.7;
      const redPeak = 0.3 + nearFactor * 1.2;

      beepLightGreen.setAttribute('material', `emissive:#1eff73; emissiveIntensity:${greenPeak.toFixed(2)}`);
      beepLightRed.setAttribute('material', `emissive:#ff2a2a; emissiveIntensity:${redPeak.toFixed(2)}`);

      setTimeout(()=>{
        beepLightGreen.setAttribute('material', 'emissive:#1eff73; emissiveIntensity:0.15');
        beepLightRed.setAttribute('material', 'emissive:#ff2a2a; emissiveIntensity:0.10');
      }, 130);
    }

    function robotBeep(){
      const cam = document.querySelector('#rig').object3D.position;
      const rb = saber.object3D.position;
      const dx = cam.x - rb.x, dz = cam.z - rb.z;
      const dist = Math.max(0.3, Math.hypot(dx, dz));
      const vol = Math.max(0.01, Math.min(0.16, 0.22 / (dist * dist)));
      const freq = 640 + Math.random()*460;
      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      osc.type = Math.random() > 0.5 ? 'square' : 'triangle';
      osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
      gain.gain.setValueAtTime(0.0001, audioCtx.currentTime);
      gain.gain.exponentialRampToValueAtTime(vol, audioCtx.currentTime + 0.01);
      gain.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + 0.14);
      osc.connect(gain); gain.connect(audioCtx.destination);
      osc.start(); osc.stop(audioCtx.currentTime + 0.15);

      flashBeepLights(dist);
    }

    AFRAME.registerComponent('saber-move', {
      init() {
        this.target = null;
        this.speed = 0.95;
        this.roomHalfX = 7.5;
        this.roomMinZ = -7.5;
        this.roomMaxZ = 9.5;
        // axis-aligned blockers (x,z center + half extents)
        this.blockers = [
          {x:-5.2, z:-3.6, hx:1.65, hz:0.55},
          {x: 5.2, z:-3.6, hx:1.65, hz:0.55},
          {x: 0.0, z:-6.0, hx:7.8, hz:0.20}, // back wall collision buffer
          {x: 0.0, z:10.0, hx:7.8, hz:0.25}, // front wall collision buffer
          {x:-8.0, z: 2.0, hx:0.20, hz:7.8}, // left wall
          {x: 8.0, z: 2.0, hx:0.20, hz:7.8}  // right wall
        ];
      },
      isBlocked(x,z){
        if (x < -this.roomHalfX || x > this.roomHalfX || z < this.roomMinZ || z > this.roomMaxZ) return true;
        for (const b of this.blockers){
          if (Math.abs(x - b.x) <= b.hx && Math.abs(z - b.z) <= b.hz) return true;
        }
        return false;
      },
      tick(time, dt) {
        if (!this.target) return;
        const p = this.el.object3D.position;
        const t = this.target;
        const dx = t.x - p.x, dz = t.z - p.z;
        const dist = Math.hypot(dx, dz);
        if (dist < 0.04) { this.target = null; return; }
        const step = Math.min((dt / 1000) * this.speed, dist);
        const nx = p.x + (dx / dist) * step;
        const nz = p.z + (dz / dist) * step;

        if (!this.isBlocked(nx, nz)) {
          p.x = nx; p.z = nz;
        } else {
          this.target = null;
          return;
        }

        const yaw = Math.atan2(dx, dz);
        this.el.object3D.rotation.y = yaw;
      },
      moveTo(point) {
        if (this.isBlocked(point.x, point.z)) return false;
        this.target = { x: point.x, z: point.z };
        return true;
      }
    });

    function localBrain(msg) {
      const m = msg.toLowerCase();
      if (m.includes('hello') || m.includes('hey') || m.includes('hi')) return 'Hey Christopher â€” Saber here in the workshop.';
      if (m.includes('move') || m.includes('walk')) { setMode(1); return 'Guide mode: point on the floor and click trigger â€” I will move there.'; }
      if (m.includes('build') || m.includes('project')) { setMode(2); return 'Builder mode active. Let\'s prototype something useful.'; }
      return `Got it: "${msg}".`;
    }

    function speak(text){
      if (!('speechSynthesis' in window)) return;
      const u = new SpeechSynthesisUtterance(text);
      u.rate = 1.0; u.pitch = 1.0; u.volume = 0.9;
      window.speechSynthesis.cancel();
      window.speechSynthesis.speak(u);
    }

    function respond(msg){
      const reply = localBrain(msg);
      speak(reply);
      statusEl.textContent = reply;
    }

    navPlane.addEventListener('click', async (e) => {
      if (audioCtx.state === 'suspended') { try { await audioCtx.resume(); } catch {} }
      if (!e.detail || !e.detail.intersection) return;
      const p = e.detail.intersection.point;
      const mover = saber.components['saber-move'];
      const ok = mover ? mover.moveTo(p) : false;
      if (!ok) {
        statusEl.textContent = 'Blocked path (wall/table). Pick a clearer floor spot.';
        return;
      }
      targetMarker.setAttribute('position', `${p.x} 0.01 ${p.z}`);
      targetMarker.setAttribute('visible', true);
      statusEl.textContent = `Moving to x:${p.x.toFixed(2)} z:${p.z.toFixed(2)}`;
    });

    document.getElementById('sendBtn').addEventListener('click', ()=>{
      const msg = userInput.value.trim();
      if(!msg) return;
      statusEl.textContent = 'Thinking...';
      setTimeout(()=>respond(msg), 160);
      userInput.value='';
    });
    userInput.addEventListener('keydown', e=>{ if(e.key==='Enter') document.getElementById('sendBtn').click(); });

    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    let rec = null;
    if (SR) {
      rec = new SR(); rec.lang = 'en-US'; rec.interimResults = false; rec.maxAlternatives = 1;
      rec.onstart = ()=> statusEl.textContent = 'Listening...';
      rec.onresult = (e)=> { const t = e.results[0][0].transcript; userInput.value = t; respond(t); };
      rec.onerror = ()=> statusEl.textContent = 'Voice input unavailable on this browser.';
    }
    document.getElementById('micBtn').addEventListener('click', ()=>{ if (!rec) { statusEl.textContent = 'SpeechRecognition not supported here.'; return; } rec.start(); });
    document.getElementById('modeBtn').addEventListener('click', ()=> setMode(modeIndex + 1));

    const modelEl = document.querySelector('[gltf-model]');
    if (modelEl) {
      modelEl.addEventListener('model-loaded', ()=> statusEl.textContent = 'Model + lab loaded. Autonomy contract active. Point at floor to move Saber.');
      modelEl.addEventListener('model-error', ()=> statusEl.textContent = 'Model failed to load. Check connection and reload.');
    }

    // ambient digital motion beeps
    setInterval(() => {
      if (audioCtx.state === 'running') robotBeep();
    }, 1200);
  </script>
</body>
</html>